  var l3 = new ee.ImageCollection('LANDSAT/LM3_L1T')
    .filter(ee.Filter.inList('LANDSAT_SCENE_ID', [
      'LM30950891982095ASA00', 'LM30360121982216PAC00', 'LM30910241982163AAA03',
      'LM30950891982095ASA00', 'LM30910241982163AAA03', 'LM30950891982095ASA00',
      'LM30020661982110XXX01', 'LM30100131982190PAC00', 'LM30040471983089XXX01',
      'LM30050471982347AAA03', 'LM31090631983051AAA05', 'LM30180131983067XXX01',
      'LM30230471983036AAA03', 'LM31520411983058XXX03', 'LM30440131983057AAA05',
      'LM30100621983059XXX02', 'LM30950891982095ASA00', 'LM30440131983057AAA05',
      'LM30100621983059XXX02', 'LM30180131983067XXX01', 'LM30040471983089XXX01',
      'LM31110281983089HAJ00', 'LM30230471983036AAA03', 'LM31110281983089HAJ00',
      'LM31520411983058XXX03', 'LM31090631983051AAA05', 'LM32010241980213AAA06',
      'LM30950891982095ASA00', 'LM30220451982094AAA03', 'LM30950891982095ASA00',
      'LM30050471982347AAA03', 'LM30100131982190PAC00', 'LM30950891982095ASA00',
      'LM30020661982110XXX01', 'LM30950891982095ASA00', 'LM30950781982113ASA00',
      'LM30360121982216PAC00', 'LM30950891982095ASA00', 'LM30950781982113ASA00',
      'LM30950891982095ASA00', 'LM30220451982094AAA03', 'LM31160661982225ASA00',
      'LM30100131982262PAC00', 'LM30360131982216PAC00', 'LM30220471982130AAA03',
      'LM30060221982258PAC00', 'LM30020671982110XXX01', 'LM31160661982225ASA00',
      'LM31060111982106AAA03', 'LM30910241982271AAA05', 'LM31160661982225ASA00',
      'LM31060111982106AAA03', 'LM30220471982130AAA03', 'LM30360131982216PAC00',
      'LM31160661982225ASA00', 'LM30950781982131ASA00', 'LM31160661982225ASA00',
      'LM30100131982262PAC00', 'LM30910241982271AAA05', 'LM30020671982110XXX01',
      'LM31160661982225ASA00', 'LM32360741983052AAA03', 'LM31160661982225ASA00',
      'LM30730131983086XXX01', 'LM30060221982258PAC00', 'LM30950781982131ASA00',
      'LM31530411983059XXX02', 'LM30240381983055XXX01', 'LM31120281983018HAJ00',
      'LM30730131983086XXX01', 'LM30240381983055XXX01', 'LM31120281983018HAJ00',
      'LM31090701983087XXX01', 'LM30080521983021XXX01', 'LM31090701983087XXX01',
      'LM32360741983052AAA03', 'LM30080521983021XXX01', 'LM31530411983059XXX02',
      'LM30080521983057AAA03', 'LM31740411983062XXX01', 'LM30740111983069XXX01', 
      'LM32360751983052AAA05', 'LM30240381983073XXX01', 'LM31090711983087XXX01', 
      'LM30740111983069XXX01', 'LM31120281983054HAJ00', 'LM30080521983057AAA03', 
      'LM31090711983087XXX01', 'LM30240381983073XXX01', 'LM31120281983054HAJ00', 
      'LM32360751983052AAA05', 'LM31740411983062XXX01', 'LM31650111982202AAA03', 
      'LM30020681982110XXX01', 'LM30230381982239AAA05', 'LM30370111982181PAC00', 
      'LM30950781982185ASA00', 'LM31060121982106AAA03', 'LM30370111982181PAC00', 
      'LM30060221982276PAC00', 'LM31060121982106AAA03', 'LM30230381982239AAA05', 
      'LM30910241982289AAA06', 'LM30020681982110XXX01', 'LM31650111982202AAA03', 
      'LM30110121982299PAC00', 'LM30910241982289AAA06', 'LM30060221982276PAC00', 
      'LM30950781982185ASA00', 'LM31540221982173AAA08', 'LM30110121982299PAC00', 
      'LM31540221982173AAA08', 'LM32360761983052AAA05', 'LM31740431983026XXX00',
      'LM30240391983055XXX03', 'LM30740111983087XXX01', 'LM30100281983023AAA06', 
      'LM31120291983018HAJ00', 'LM30740111983087XXX01', 'LM31120291983018HAJ00', 
      'LM31740431983026XXX00', 'LM32360761983052AAA05', 'LM30240391983055XXX03', 
      'LM30020701982128AAA03', 'LM30060231982150PAC00', 'LM30950781982203ASA00', 
      'LM31060131982106AAA03', 'LM30950781982203ASA00', 'LM31060131982106AAA03', 
      'LM30020701982128AAA03', 'LM30060231982150PAC00', 'LM32460611983062XXX02', 
      'LM31090741983051AAA05', 'LM30100281983041AAA05', 'LM32460611983062XXX02', 
      'LM31120291983090HAJ00', 'LM30100281983041AAA05', 'LM30100281983023AAA06', 
      'LM31090731983051AAA05', 'LM30110131982119PAC00', 'LM32320741982035AAA03',
      'LM31680111982187AAA03', 'LM30370111982217PAC00', 'LM30060231982258PAC00',
      'LM31540221982209XXX02', 'LM30230391982239AAA05', 'LM31060141982106AAA03'
  ]).not())
    
  var l2 = new ee.ImageCollection('LANDSAT/LM2_L1T')
    .filter(ee.Filter.inList('LANDSAT_SCENE_ID', [
      'LM20160321977285GMD03', 'LM20160321977357AAA02', 'LM20350381977286GDS03',
      'LM20350381977286GDS03', 'LM20350381977322GDS03', 'LM20350381977340GDS03',
      'LM20400331981036AAA04', 'LM20360371977197GDS03', 'LM20360381977161GDS06',
      'LM20360381977251GDS03', 'LM20360381977287GDS03', 'LM20400331981036AAA04',
      'LM20360381977305GDS03', 'LM20360381977323GDS03', 'LM20360381977323GDS03',
      'LM20360381977341GDS03', 'LM20360381977359GDS03', 'LM20370361977198GDS03',
      'LM20370361977216GDS03', 'LM20370371977198GDS03', 'LM20370371977216GDS03']).not())
    
  var l1 = new ee.ImageCollection('LANDSAT/LM1_L1T')
    .filter(ee.Filter.inList('LANDSAT_SCENE_ID', [
      'LM10400041977243PAC00', 'LM10160321977057GMD03', 'LM10400261976180AAA02',
      'LM10160321977039GMD03', 'LM10760111977134FAK03', 'LM10350381977040GDS04']).not())

var images = ee.ImageCollection(
  //l8.merge(l7).merge(l5).merge(l4).merge(l3).merge(l2)
  l3.merge(l2).merge(l1)
  //l2.merge(l1)
  ).map(function(i) {
    return i.updateMask(i.select('B7').gt(1).multiply(i.select('B4').gt(1)).multiply(i.select('B6').gt(1)).multiply(i.select('B5').gt(1)))
  })


Map.addLayer(images, {}, 'all', false)

var vis = {min:10, max:100}

function getNdwi(start, stop) {
  var filtered = images
    .filterDate(start, stop)
    
  Map.addLayer(filtered.select(0).count(), {min:0, max:50, palette:['d7191c','fdae61','ffffbf','a6d96a','1a9641']}, 'count', false)

  var countFilter = filtered.select(0).count().gt(0)

  var p = filtered
    .select(['B5', 'B6', 'B4']).reduce(ee.Reducer.percentile([15]), 4)
    //.mask(countFilter)

  Map.addLayer(p, vis, start + ' - ' + stop, false)
  
  var bands = ['B7', 'B4']
  var ndwi = filtered.select(bands).reduce(ee.Reducer.percentile([15]), 4).rename(bands)
    .unitScale(0, 255)
    .normalizedDifference(bands)
    //.mask(countFilter)

  Map.addLayer(ndwi, {min: -1, max: 1}, 'NDWI ' + start + ' - ' + stop, false)
  
  return ndwi;
}

var ndwiOld = getNdwi('1972-01-01', '1977-01-01')  
var ndwiNew = getNdwi('1978-01-01', '1983-01-01')  

var diff = ndwiOld.subtract(ndwiNew)
  //.updateMask(ndwiOld.min(ndwiNew).lt(-0.1).and(ndwiOld.max(ndwiNew).gt(0)))

Map.addLayer(diff, {min: -1, max: 1, palette: ['00ff00', '000000', '00d8ff']}, 'NDWI diff', true)

var diffThreshold = 0.4
diff = diff.mask(diff.abs().gt(diffThreshold))
Map.addLayer(diff, {min: -0.5, max: 0.5, palette: ['00ff00', '000000', '00d8ff']}, 'NDWI diff (>'+ diffThreshold +  ')', true)


/*
var bands = ['B7', 'B4']
var scale = images.select(bands)
  .map(function(i) {
      var date = ee.Date(i.get('system:time_start'));
      var year = date.get('year').subtract(1950)
      return ee.Image(year).byte().addBands(i.unitScale(0, 255).normalizedDifference(bands));
  })
  .reduce(ee.Reducer.linearFit(), 16).select('scale')

Map.addLayer(scale, {palette: ['00ff00', '000000', '00d8ff']}, 'scale', false)
*/

/*
var l8 = new ee.ImageCollection('LANDSAT/LC8_L1T_TOA')
var p = l8.select(['B4', 'B5', 'B3']).reduce(ee.Reducer.percentile([15]), 4)
Map.addLayer(p, {min:0.03, max:0.3}, 'L8 453', true)

var ndwi8 = ee.ImageCollection(
    l8.select(['B5', 'B3']).map(function(i) { return i.reproject('EPSG:4326', null, 60) })
   )
  .reduce(ee.Reducer.percentile([15]), 4).rename(['B5', 'B3'])
  .normalizedDifference(['B5', 'B3'])
  .unitScale(-0.63, 0.63)
  
Map.addLayer(ndwi8, {min: 0, max: 1}, 'L8 NDWI', true)

var diff = ndwi2.subtract(ndwi8)//.focal_mean(60,'circle', 'meters')

diff = diff.mask(diff.abs().gt(0.3))
Map.addLayer(diff, {min: -0.5, max: 0.5, palette: ['00ff00', '000000', '00d8ff']}, 'NDWI diff', true)
*/